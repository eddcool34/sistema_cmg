<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Sistema CMG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <h1>üîç Sistema CMG - Herramienta de Depuraci√≥n</h1>

    <div class="debug-box">
        <h2>Estado del Sistema</h2>
        <div id="status"></div>
    </div>

    <div class="debug-box">
        <h2>LocalStorage</h2>
        <div id="localStorage"></div>
    </div>

    <div class="debug-box">
        <h2>Acciones</h2>
        <button onclick="limpiarTurno()">Limpiar Turno</button>
        <button onclick="limpiarTodo()" class="danger">Limpiar Todo</button>
        <button onclick="verificarEstado()">Actualizar Estado</button>
        <button onclick="abrirSistema()">Abrir Sistema Principal</button>
    </div>

    <div class="debug-box">
        <h2>Consola de Errores</h2>
        <div id="console"></div>
    </div>

    <script>
        // Capturar errores de consola
        const consoleDiv = document.getElementById('console');
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            consoleDiv.innerHTML += `<div class="error">ERROR: ${args.join(' ')}</div>`;
        };

        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            consoleDiv.innerHTML += `<div class="warning">WARNING: ${args.join(' ')}</div>`;
        };

        function verificarEstado() {
            const statusDiv = document.getElementById('status');
            const localStorageDiv = document.getElementById('localStorage');

            // Verificar turno actual
            const turnoActual = localStorage.getItem('turnoActual');
            let statusHTML = '';

            if (turnoActual) {
                try {
                    const turno = JSON.parse(turnoActual);
                    const fechaHoy = new Date().toLocaleDateString('es-MX');
                    const esHoy = turno.fecha === fechaHoy;

                    statusHTML += `<div class="${esHoy ? 'success' : 'warning'}">`;
                    statusHTML += `<strong>Turno encontrado:</strong><br>`;
                    statusHTML += `ID: ${turno.turno_id}<br>`;
                    statusHTML += `Cajero: ${turno.cajero}<br>`;
                    statusHTML += `Fecha: ${turno.fecha} ${esHoy ? '‚úì (Hoy)' : '‚ö†Ô∏è (No es hoy)'}<br>`;
                    statusHTML += `Hora apertura: ${turno.hora_apertura}<br>`;
                    statusHTML += `Estado: ${turno.estado}<br>`;
                    statusHTML += `</div>`;

                    if (!esHoy) {
                        statusHTML += `<div class="warning">‚ö†Ô∏è El turno NO es de hoy (Hoy: ${fechaHoy}). El sistema lo rechazar√°.</div>`;
                    }
                } catch (error) {
                    statusHTML += `<div class="error">ERROR al parsear turno: ${error.message}</div>`;
                }
            } else {
                statusHTML += `<div class="warning">‚ö†Ô∏è No hay turno abierto. Debes abrir un turno para usar el sistema.</div>`;
            }

            statusDiv.innerHTML = statusHTML;

            // Mostrar todo el localStorage
            let localStorageHTML = '<pre>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                localStorageHTML += `<strong>${key}:</strong>\n${value}\n\n`;
            }
            localStorageHTML += '</pre>';
            localStorageDiv.innerHTML = localStorageHTML;

            console.log('‚úÖ Estado verificado');
        }

        function limpiarTurno() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el turno actual?')) {
                localStorage.removeItem('turnoActual');
                console.log('‚úÖ Turno eliminado');
                alert('Turno eliminado. Ahora recarga el sistema principal.');
                verificarEstado();
            }
        }

        function limpiarTodo() {
            if (confirm('¬øADVERTENCIA! Esto eliminar√° TODOS los datos del localStorage. ¬øEst√°s seguro?')) {
                if (confirm('¬øREALMENTE seguro? Esto no se puede deshacer.')) {
                    localStorage.clear();
                    console.log('üóëÔ∏è Todo el localStorage ha sido limpiado');
                    alert('Todo eliminado. Recarga el sistema.');
                    verificarEstado();
                }
            }
        }

        function abrirSistema() {
            window.location.href = 'sistema_cmg.html';
        }

        // Verificar estado al cargar
        verificarEstado();
    </script>
</body>
</html>
